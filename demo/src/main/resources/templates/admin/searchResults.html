<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>搜索结果</title>
  <link rel="stylesheet" href="/static/vendor/bootstrap/css/bootstrap.min.css">
  <style>
    .table {
      font-size: 12px; /* 调整表格字体大小 */
    }
    .btn-spacing {
      margin-right: 10px; /* 调整按钮之间的间距 */
    }
  </style>
</head>
<body>
<div class="container mt-5">
  <a href="/adminHome" class="btn btn-secondary mt-3">Back to Home</a>
  <a href="/resourcesLib" class="btn btn-secondary mt-3">Back to Source Databases</a>
  <h1>Searching results</h1>

  <div class="mb-4">
    <h2><span th:text="${resultCount}">0</span> results found</h2>
  </div>

  <!-- 显示搜索结果的条数 -->
  <div class="mb-4">
    <form id="searchForm" action="/test/search2" method="get">
      <div class="form-group">
        <label for="searchType">Search By</label>
        <select id="searchType" name="searchType" class="form-control" onchange="updateSearchField()">
          <option value="allkinds">All</option>
          <option value="title">Title</option>
          <option value="isbn">ISBN</option>
          <option value="alternativeTitle">Alternative Title</option>
          <option value="author">Author</option>
        </select>
      </div>

      <div class="form-group" id="searchTitleGroup" style="display: none;">
        <label for="searchTitle">Title</label>
        <input type="text" id="searchTitle" class="form-control" placeholder="Enter title">
      </div>

      <div class="form-group" id="searchIsbnGroup" style="display: none;">
        <label for="searchIsbn">ISBN</label>
        <input type="text" id="searchIsbn" class="form-control" placeholder="Enter ISBN">
      </div>

      <div class="form-group" id="searchAlternativeTitleGroup" style="display: none;">
        <label for="searchAlternativeTitle">Alternative Title</label>
        <input type="text" id="searchAlternativeTitle" class="form-control" placeholder="Enter alternative title">
      </div>

      <div class="form-group" id="searchAuthorGroup" style="display: none;">
        <label for="searchAuthor">Author</label>
        <input type="text" id="searchAuthor" class="form-control" placeholder="Enter author">
      </div>

      <div class="form-group" id="searchAllkindsGroup" style="display: none;">
        <label for="searchAllkinds">All</label>
        <input type="text" id="searchAllkinds" class="form-control" placeholder="Enter value">
      </div>

      <!-- Existing form groups for other filters -->
      <div class="form-group">
        <label for="publisher">Publisher</label>
        <select id="publisher" name="publisher" class="form-control">
          <option value="" th:selected="${publisher == null}">All kinds</option>
          <th:block th:each="pub : ${publishers}">
            <option th:value="${pub}" th:text="${pub}" th:selected="${pub == publisher}"></option>
          </th:block>
        </select>
      </div>

      <div class="form-group">
        <label for="sourceType">Source Type</label>
        <select id="sourceType" name="sourceType" class="form-control">
          <option value="" th:selected="${sourceType == null}">All kinds</option>
          <th:block th:each="type : ${sourceTypes}">
            <option th:value="${type}" th:text="${type}" th:selected="${type == sourceType}"></option>
          </th:block>
        </select>
      </div>

      <div class="form-group">
        <label for="language">Language</label>
        <select id="language" name="language" class="form-control">
          <option value="" th:selected="${language == null}">All kinds</option>
          <th:block th:each="lang : ${languages}">
            <option th:value="${lang}" th:text="${lang}" th:selected="${lang == language}"></option>
          </th:block>
        </select>
      </div>

      <div class="form-group">
        <label for="published">Published</label>
        <select id="published" name="published" class="form-control">
          <option value="" th:selected="${published == null}">All kinds</option>
          <th:block th:each="pubDate : ${publisheds}">
            <option th:value="${pubDate}" th:text="${pubDate}" th:selected="${pubDate == published}"></option>
          </th:block>
        </select>
      </div>

      <div class="form-group">
        <label for="status">Status</label>
        <select id="status" name="status" class="form-control">
          <option value="" th:selected="${status == null}">All kinds</option>
          <th:block th:each="stat : ${statuses}">
            <option th:value="${stat}" th:text="${stat}" th:selected="${stat == status}"></option>
          </th:block>
        </select>
      </div>

      <div class="form-group">
        <label for="databaseId">Database</label>
        <select id="databaseId" name="databaseId" class="form-control">
          <option value="" th:selected="${databaseId == null}">All kinds</option>
          <th:block th:each="entry : ${databaseMap}">
            <option th:value="${entry.key}" th:text="${entry.value}" th:selected="${entry.key == databaseId}"></option>
          </th:block>
        </select>
      </div>

      <!-- Hidden field to store search value -->
      <input type="hidden" id="searchValue" name="searchValue">

      <button type="submit" class="btn btn-primary">Search</button>
    </form>
  </div>

  <script>
    function updateSearchField() {
      var searchType = document.getElementById('searchType').value;
      var searchTitleGroup = document.getElementById('searchTitleGroup');
      var searchIsbnGroup = document.getElementById('searchIsbnGroup');
      var searchAlternativeTitleGroup = document.getElementById('searchAlternativeTitleGroup');
      var searchAuthorGroup = document.getElementById('searchAuthorGroup');
      var searchAllkindsGroup = document.getElementById('searchAllkindsGroup');

      // Hide all search fields
      searchTitleGroup.style.display = 'none';
      searchIsbnGroup.style.display = 'none';
      searchAlternativeTitleGroup.style.display = 'none';
      searchAuthorGroup.style.display = 'none';
      searchAllkindsGroup.style.display = 'none';

      // Show the selected search field
      if (searchType === 'title') {
        searchTitleGroup.style.display = 'block';
      } else if (searchType === 'isbn') {
        searchIsbnGroup.style.display = 'block';
      } else if (searchType === 'alternativeTitle') {
        searchAlternativeTitleGroup.style.display = 'block';
      }else if (searchType === 'author') {
        searchAuthorGroup.style.display = 'block';
      }else if (searchType === 'allkinds') {
        searchAllkindsGroup.style.display = 'block';
      }
    }

    document.getElementById('searchForm').addEventListener('submit', function (event) {
      var searchType = document.getElementById('searchType').value;
      var searchValueInput = document.getElementById('searchValue');
      var searchTitle = document.getElementById('searchTitle');
      var searchIsbn = document.getElementById('searchIsbn');
      var searchAlternativeTitle = document.getElementById('searchAlternativeTitle');
      var searchAuthor = document.getElementById('searchAuthor');
      var searchAllkinds = document.getElementById('searchAllkinds');

      // Set the value for searchValue based on the selected searchType
      if (searchType === 'title') {
        searchValueInput.value = searchTitle.value;
      } else if (searchType === 'isbn') {
        searchValueInput.value = searchIsbn.value;
      } else if (searchType === 'alternativeTitle') {
        searchValueInput.value = searchAlternativeTitle.value;
      }else if (searchType === 'author') {
        searchValueInput.value = searchAuthor.value;
      }else if (searchType === 'allkinds') {
        searchValueInput.value = searchAllkinds.value;
      }
    });

    // Initialize the form to show the correct field based on the current search type
    updateSearchField();
  </script>



  <style>
    .table-responsive {
      overflow-x: auto;
    }
  </style>
  <!-- 搜索结果表格 -->
  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
      <tr>
        <th>ISBN</th>
        <th>Title</th>
        <th>Alternate Title</th>
        <th>Authors</th>
        <th>Publisher</th>
        <th>Published</th>
        <th>Source Type</th>
        <th>Pdf</th>
        <th>Epub</th>
        <th>Database</th>
        <th>Status</th>
        <th>View Online</th>
        <th>Download</th>
        <th>Borrow</th>
        <th>Loan Status</th>
        <th>Operate</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="book : ${books}">
        <td th:text="${book.isbn}">ISBN</td>
        <td th:text="${book.title}">Title</td>
        <td th:text="${book.alternativeTitle}">Alternative Title</td>
        <td th:text="${book.author}">Author</td>
        <td th:text="${book.publisher}">Publisher</td>
        <td th:text="${book.published}">Published</td>
        <td th:text="${book.sourceType}">Source Type</td>
        <td>
          <a th:if="${book.downloadLink != null && !book.downloadLink.isEmpty() && book.downloadLink != 'NULL'}"
             th:href="@{/downloadfiles/{bookId}(bookId=${book.id})}">
            Download
          </a>
          <span th:if="${book.downloadLink == null || book.downloadLink.isEmpty() || book.downloadLink == 'NULL'}"
                data-toggle="modal"
                data-target="#uploadPdfModal"
                th:data-id="${book.id}"
                class="upload-link">
      Not available (Upload)
    </span>
        </td>

        <!-- 模态框 -->
        <div class="modal fade" id="uploadPdfModal" tabindex="-1" role="dialog" aria-labelledby="uploadPdfModalLabel" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="uploadPdfModalLabel">Upload PDF</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <!-- 文件上传表单 -->
                <form id="uploadPdfForm" enctype="multipart/form-data">
                  <input type="hidden" id="bookIdField" name="id">
                  <div class="form-group">
                    <label for="fileInput">Choose PDF file</label>
                    <input type="file" class="form-control-file" id="fileInput" name="file" accept=".pdf" required>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="uploadButton">Upload</button>
              </div>
            </div>
          </div>
        </div>

        <td>
          <a th:if="${book.epubPath != null && !book.epubPath.isEmpty() && book.epubPath != 'NULL'}"
          th:href="@{/viewEpub/{bookId}(bookId=${book.id})}">
            Download
          </a>
          <span th:if="${book.epubPath == null || book.epubPath.isEmpty()||book.epubPath == 'NULL'}"
                data-toggle="modal"
                data-target="#uploadEpubModal"
                th:data-id="${book.id}"
                class="upload-link">
      Not available (Upload)
    </span>
        </td>

        <div class="modal fade" id="uploadEpubModal" tabindex="-1" role="dialog" aria-labelledby="uploadEpubModalLabel" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="uploadEpubModalLabel">Upload Epub</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <!-- 文件上传表单 -->
                <form id="uploadEpubForm" enctype="multipart/form-data">
                  <input type="hidden" id="EpubIdField" name="id">
                  <div class="form-group">
                    <label for="fileInput">Choose Epub file</label>
                    <input type="file" class="form-control-file" id="EpubfileInput" name="file" accept=".epub" required>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="uploadEpubButton">Upload</button>
              </div>
            </div>
          </div>
        </div>

        <td th:text="${book.resourcesId}">Resources ID</td>
        <td>
          <div class="dropdown">
            <button class="btn btn-sm btn-primary dropdown-toggle" type="button" id="statusDropdown-${book.id}"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <span th:text="${book.status == 'Published' ? 'Published' : 'Unpublished'}"></span>
            </button>
            <div class="dropdown-menu" aria-labelledby="statusDropdown-${book.id}">
              <a class="dropdown-item"
                 href="#"
                 th:onclick="'updateField(' + ${book.id} + ', \'status\', \'Published\')'"
                 th:text="'Published'"></a>
              <a class="dropdown-item"
                 href="#"
                 th:onclick="'updateField(' + ${book.id} + ', \'status\', \'Unpublished\')'"
                 th:text="'Unpublished'"></a>
            </div>
          </div>
        </td>

        <td>
          <div class="dropdown">
            <button class="btn btn-sm btn-primary dropdown-toggle" type="button" id="viewDropdown-${book.id}"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <span th:text="${book.view}">View</span>
            </button>
            <div class="dropdown-menu" aria-labelledby="viewDropdown-${book.id}">
              <a class="dropdown-item"
                 href="#"
                 th:onclick="'updateField(' + ${book.id} + ', \'view\', \'Enable\')'"
                 th:text="'Enable'"></a>
              <a class="dropdown-item"
                 href="#"
                 th:onclick="'updateField(' + ${book.id} + ', \'view\', \'Disable\')'"
                 th:text="'Disable'"></a>
            </div>
          </div>
        </td>
        <td>
          <div class="dropdown">
            <button class="btn btn-sm btn-primary dropdown-toggle" type="button" id="downloadDropdown-${book.id}"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <span th:text="${book.download}">Download</span>
            </button>
            <div class="dropdown-menu" aria-labelledby="downloadDropdown-${book.id}">
              <a class="dropdown-item"
                 href="#"
                 th:onclick="'updateField(' + ${book.id} + ', \'download\', \'Enable\')'"
                 th:text="'Enable'"></a>
              <a class="dropdown-item"
                 href="#"
                 th:onclick="'updateField(' + ${book.id} + ', \'download\', \'Disable\')'"
                 th:text="'Disable'"></a>
            </div>
          </div>
        </td>

        <td>
          <div class="dropdown">
            <!-- 下拉按钮 -->
            <button class="btn btn-sm btn-primary dropdown-toggle" type="button" id="loanDropdown-${book.id}"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <span th:text="${book.loaned > 0 ? 'Enable' : 'Disable'}"></span>
            </button>
            <!-- 下拉菜单 -->
            <div class="dropdown-menu" aria-labelledby="loanDropdown-${book.id}">
              <a class="dropdown-item"
                 href="#"
                 th:onclick="'updateField(' + ${book.id} + ', \'loan\', \'0\')'"
                 th:text="'Disable'"></a>
              <a class="dropdown-item"
                 href="#"
                 th:onclick="'enableBorrowWithPeriod(' + ${book.id} + ')'"
                 th:text="'Enable'"></a>
            </div>

          </div>
        </td>


        <td th:text="${book.loanLabel}">Loaned</td>
        <td>
          <form th:action="@{/test/deleteList/{fileID}(fileID=${book.id})}" method="post" style="display:inline;">
            <input type="hidden" name="title" th:value="${title}">
            <input type="hidden" name="publisher" th:value="${publisher}">
            <input type="hidden" name="sourceType" th:value="${sourceType}">
            <input type="hidden" name="language" th:value="${language}">
            <input type="hidden" name="published" th:value="${published}">
            <input type="hidden" name="status" th:value="${status}">
            <input type="hidden" name="databaseId" th:value="${databaseId}">
            <button type="submit" class="btn btn-danger btn-spacing">delete</button>
          </form>
          <form th:action="@{book/{fileID}(fileID=${book.id})}" method="get" style="display:inline;">
            <input type="hidden" name="title" th:value="${title}">
            <input type="hidden" name="publisher" th:value="${publisher}">
            <input type="hidden" name="sourceType" th:value="${sourceType}">
            <input type="hidden" name="language" th:value="${language}">
            <input type="hidden" name="published" th:value="${published}">
            <input type="hidden" name="status" th:value="${status}">
            <input type="hidden" name="databaseId" th:value="${databaseId}">
            <button type="submit" class="btn btn-success btn-spacing">edit</button>
          </form>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- Bootstrap JS -->
  <script src="/static/vendor/jquery/jquery.min.js"></script>
  <script src="/static/vendor/popper/popper.min.js"></script>
  <script src="/static/js/bootstrap/bootstrap.min.js"></script>
  <!-- 自定义JS -->
  <script>
    function enableBorrowWithPeriod(bookId) {
      let period = prompt("Please enter the borrow period (days):", "30");
      if (period != null && !isNaN(period)) {
        updateField(bookId, 'loan', period);
      } else {
        alert("Please enter a valid number.");
      }
    }


    function updateField(id, editType, editField) {
      fetch('/test/updateField', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({
          id: id,
          editType: editType,
          editField: editField
        })
      })
              .then(response => response.text())
              .then(result => {
                console.log(result);
                // 处理成功响应，比如更新 UI 或显示提示弹窗
                alert('Update successful!'); // 提示用户更新成功
                location.reload(); // 可选：刷新页面
              })
              .catch(error => console.error('Error:', error));
    }

    document.addEventListener('DOMContentLoaded', function () {
      var uploadLinks = document.querySelectorAll('.upload-link');

      uploadLinks.forEach(function(link) {
        link.addEventListener('click', function() {
          var bookId = this.getAttribute('data-id');
          document.getElementById('bookIdField').value = bookId;
        });
      });

      document.getElementById('uploadButton').addEventListener('click', function() {
        var form = document.getElementById('uploadPdfForm');
        var formData = new FormData(form);

        fetch('/uploadSinglePDF', {
          method: 'POST',
          body: formData
        })
                .then(response => response.text())
                .then(data => {
                  $('#uploadPdfModal').modal('hide');
                  alert('Upload successful: ' + data);
                  // 刷新页面
                  window.location.reload();
                })
                .catch(error => {
                  $('#uploadPdfModal').modal('hide');
                  alert('Upload failed: ' + error.message);
                  // 刷新页面
                  window.location.reload();
                });
      });
    });

    document.addEventListener('DOMContentLoaded', function () {
      // 获取所有的 upload-link 元素
      var uploadLinks = document.querySelectorAll('.upload-link');

      // 为每个 upload-link 元素添加点击事件监听器
      uploadLinks.forEach(function(link) {
        link.addEventListener('click', function() {
          var bookId = this.getAttribute('data-id');
          document.getElementById('EpubIdField').value = bookId;
        });
      });

      // 获取上传按钮元素
      var uploadButton = document.getElementById('uploadEpubButton');

      // 为上传按钮添加点击事件监听器
      uploadButton.addEventListener('click', function() {
        var form = document.getElementById('uploadEpubForm');
        var formData = new FormData(form);

        // 使用 fetch API 发送表单数据到服务器
        fetch('/uploadSingleEpub', {
          method: 'POST',
          body: formData
        })
                .then(response => response.text())
                .then(data => {
                  // 处理成功响应
                  $('#uploadEpubModal').modal('hide');
                  alert('Upload successful: ' + data);
                  window.location.reload(); // 刷新页面
                })
                .catch(error => {
                  // 处理错误
                  $('#uploadEpubModal').modal('hide');
                  console.error('Fetch error: ', error);
                  alert('Upload failed: ' + error.message);
                  window.location.reload(); // 刷新页面
                });
      });
    });


  </script>
</div>
<!-- FontAwesome 5 -->
<script src="/static/vendor/fontawesome/js/fontawesome-all.min.js" defer></script>
<!-- Scripts used only for this demo only - Remove these in your project -->
<script src="/static/vendor/jquery-scrollbar/js/jquery-scrollbar.min.js"></script>
<script src="/static/vendor/jquery-scrollLock/jquery-scrollLock.min.js"></script>
<script src="/static/vendor/sticky-kit/sticky-kit.min.js"></script>
<script src="/static/vendor/highlight/js/highlight.min.js"></script>
<script src="/static/vendor/clipboard-js/clipboard.min.js"></script>
<script src="/static/vendor/holderjs/holder.min.js"></script>
<script src="/static/js/demo.js"></script>
<script src="/static/vendor/textarea-autosize/textarea-autosize.min.js"></script>

</body>
</html>